{
  "entities": {
    "Restaurant": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Restaurant",
      "type": "object",
      "description": "Represents a restaurant and its loyalty program configuration.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Restaurant entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the restaurant."
        },
        "reward": {
          "type": "string",
          "description": "The reward offered to customers after reaching a certain number of stamps."
        },
        "googleLink": {
          "type": "string",
          "description": "The Google Maps link for the restaurant's location.",
          "format": "uri"
        },
        "stampsGiven": {
          "type": "number",
          "description": "The total number of stamps given out by the restaurant."
        },
        "referralsCount": {
          "type": "number",
          "description": "The number of successful referrals attributed to this restaurant."
        }
      },
      "required": [
        "id",
        "name",
        "reward"
      ]
    },
    "Client": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Client",
      "type": "object",
      "description": "Represents a customer and their loyalty card information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Client entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the client."
        },
        "cards": {
          "type": "string",
          "description": "card identifier",
          "format": "uri"
        },
        "referralCode": {
          "type": "string",
          "description": "The unique referral code assigned to the client."
        },
        "referrer": {
          "type": "string",
          "description": "The referral code of the client who referred this client. (Relationship: Client 1:N Client (self-referential))"
        }
      },
      "required": [
        "id",
        "name",
        "referralCode"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/restaurants/{restaurantId}",
        "definition": {
          "entityName": "Restaurant",
          "schema": {
            "$ref": "#/backend/entities/Restaurant"
          },
          "description": "Stores restaurant profiles and loyalty program configurations. Includes denormalized 'restaurantId' (from the path) to simplify security rules.",
          "params": [
            {
              "name": "restaurantId",
              "description": "Unique identifier for the restaurant, derived from the restaurant name."
            }
          ]
        }
      },
      {
        "path": "/clients/{clientId}",
        "definition": {
          "entityName": "Client",
          "schema": {
            "$ref": "#/backend/entities/Client"
          },
          "description": "Stores client profiles and loyalty card information. Includes denormalized 'clientId' (from the path) to simplify security rules.",
          "params": [
            {
              "name": "clientId",
              "description": "Unique identifier for the client, derived from the client's name."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the StampJoy application's loyalty program features, focusing on restaurants and clients. It emphasizes authorization independence through denormalization and structural segregation for simplified security rules and efficient data access. Since the application uses authentication (password and anonymous), the structure has been made accordingly.\n\nRestaurants:\nRestaurants are stored in the `/restaurants/{restaurantId}` collection. This structure allows easy lookup of restaurant details by ID and supports the restaurant login feature. Each restaurant document stores its configuration (reward, Google Maps link) and statistics. The `restaurantId` also encodes the restaurant name, making it easy to identify.\n\nClients:\nClients are stored in the `/clients/{clientId}` collection. Each client document contains the client's name, referral code, referrer, and a map of loyalty cards (`cards`). The `cards` map stores the number of stamps the client has at each restaurant, supporting the loyalty points tracking feature.\n\nAuthorization Independence and Denormalization:\nAuthorization independence is achieved by storing all necessary authorization information directly within the documents that require it. For instance, a client's card information (stamps) is stored directly within the client's document. This eliminates the need for `get()` calls in security rules to check parent document attributes. For example, if access to a card required checking the restaurant, the restaurant name is already included in the card.\n\nQAPs (Rules are not Filters):\nThe structure supports secure `list` operations (QAPs) by segregating data based on access requirements. Restaurants can only access their own data via path-based rules. Clients can only access their own data via path-based rules. Listing operations are performed on collections that contain only documents that the user is authorized to view.  The structure avoids mixing public and private data in the same collection, ensuring that rules can be written to allow listing without exposing unauthorized information. The membership map in the `clients` and soon `/restaurants/{restaurantId}/employees` also support QAPs for collaborative data."
  }
}